name: Build and Tag ISO

on:
  push:
    branches:
      - main 

jobs:
  build-iso:
    if: startsWith(github.event.head_commit.message, 'build-iso')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v20
        with:
          nix_version: "2.24.1"

      - name: Build ISO
        run: |
          ISO_PATH=$(nix run nixpkgs#nixos-generators -- --format iso --flake .#nixiso -o result)
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV
          TAG_NAME=$(date +"iso-%Y%m%d-%H%M%S")
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Create Release Tag
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          name: ${{ env.TAG_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          files: ${{ env.ISO_PATH }}
            
